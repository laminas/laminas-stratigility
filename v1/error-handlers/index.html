<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="laminas-stratigility">  
    <link rel="canonical" href="https://docs.laminas.dev/laminas-stratigility/v1/error-handlers/">
    <link rel="shortcut icon" href="/img/trademark-laminas-foundation-rgb.svg">

    <title>Error Handlers - laminas-stratigility - Laminas Docs</title>

    <link rel="stylesheet" href="https://docs.laminas.dev/css/styles.css">
</head>
<body id="page-top" class="components">

    
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
        
        <a class="logo-link navbar-brand offset-md-2" href="https://getlaminas.org/" data-tooltip data-placement="bottom" title="Go to the Laminas homepage">
            <img src="../../img/laminas-foundation-white.svg" height="28" alt="Laminas">
        </a>
        <a class="navbar-title" href="https://docs.laminas.dev/" data-tooltip data-placement="bottom" title="Go to the Laminas Documentation">
            Documentation
        </a>

        
        <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarSupportedContent">

            
            <ul class="navbar-nav ml-auto">
                <li class="nav-item">
                    <div class="dropdown">
                        <a class="dropdown-toggle nav-link" data-toggle="dropdown" aria-expanded="false">
                            All Docs
                        </a>
                        <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                            <a class="dropdown-item" href="https://docs.laminas.dev/components">Components</a>
                            <a class="dropdown-item" href="https://docs.mezzio.dev/">Mezzio</a>
                            <a class="dropdown-item" href="https://api-tools.getlaminas.org/docs">API Tools</a>
                            <a class="dropdown-item" href="https://docs.laminas.dev/mvc">MVC</a>
                        </div>
                    </div>
                </li>
                <li class="nav-item">
                    <a href="https://getlaminas.org/participate" class="nav-link">Community</a>
                </li>
            </ul>

            
            
                <div class="d-block d-sm-none">
                    
    <div class="subnavigation hidden-print">
        <h4 class="subnavigation__title">
            <a href="../..">laminas-stratigility</a>
        </h4>

        <h5 class="subnavigation__subtitle">Table of Contents</h5>

        <ul class="subnavigation__list">
            

                
                

                    
                    
                
            

                
                

                    
                    
                
            

                
                
                    
                        
    <li class="subnavigation__list-item ">
        <a href="../install/" class="subnavigation__link">Installation and Requirements</a>
    </li>

                    
                        
    <li class="subnavigation__list-item ">
        <a href="../usage/" class="subnavigation__link">Usage</a>
    </li>

                    
                        
    <li class="subnavigation__list-item ">
        <a href="../middleware/" class="subnavigation__link">Middleware</a>
    </li>

                    
                        
    <li class="subnavigation__list-item subnavigation__list-item--active">
        <a href="./" class="subnavigation__link">Error Handlers</a>
    </li>

                    
                        
    <li class="subnavigation__list-item ">
        <a href="../creating-middleware/" class="subnavigation__link">Creating Middleware</a>
    </li>

                    
                        
    <li class="subnavigation__list-item ">
        <a href="../executing-middleware/" class="subnavigation__link">Executing and composing middleware</a>
    </li>

                    
                        
    <li class="subnavigation__list-item ">
        <a href="../api/" class="subnavigation__link">API Reference</a>
    </li>

                    
                
            
        </ul>
    </div>

                </div>
            

            
            <div class="d-block d-sm-none">
                <div class="component-selector">
    
    <h5 class="component-selector__subtitle">Find documentation…</h5>
    <select class="form-control component-selector__control">
        <option value="/">Overview</option>
        <optgroup label="Components"></optgroup>
    </select>
</div>
            </div>
        </div>
    </div>
</nav>

    
    <header class="header">
    <div class="container">
        <div class="row">

            
            <div class="col-6 offset-md-2">
                <h1 class="header__title">
                    Components

                    
                        <small class="header__subtitle">laminas-stratigility</small>
                    
                </h1>
            </div>

            
            <div class="col-4 text-sm-right">
                
                    
<div class="version-selector">
    <div class="btn-group">
        <button type="button" class="btn dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" id="version-selector-dropdown">
            
                v1
            
        </button>
        <div class="dropdown-menu" aria-labelledby="version-selector-dropdown">
            
                
                    <a href="../../v3/intro/" class="dropdown-item">
                        
                            v3 (latest)
                        
                    </a>
                
            
                
                    <a href="../../v2/install/" class="dropdown-item">
                        
                            v2
                        
                    </a>
                
            
                
                    <a href="../install/" class="dropdown-item active">
                        
                            v1
                        
                    </a>
                
            
        </div>
    </div>
</div>


                    <a href="#" class="header__link header__link--search" data-toggle="modal" data-target="#mkdocs_search_modal" title="Open search">
                        <i class="fa fa-search"></i> Search
                    </a>
                    <a href="https://github.com/laminas/laminas-stratigility/" class="header__link header__link--github" title="Go to repository of laminas-stratigility">
                        <i class="fa fa-github"></i> GitHub
                    </a>
                
            </div>
        </div>
    </div>
</header>

    
    <div class="container">
        <div class="row">
            <div class="col-md-2 col-sm-12">
                
                
                    
    

    
    
        <div class="toc">
            <h6 class="toc__headline">On this page</h6>
            <ul class="toc__list">
                
                    <li class="toc__entry">
                        <a href="#handling-404-conditions" class="toc__link">Handling 404 conditions</a>
                    </li>
                
                    <li class="toc__entry">
                        <a href="#handling-php-errors-and-exceptions" class="toc__link">Handling PHP errors and exceptions</a>
                    </li>
                
                    <li class="toc__entry">
                        <a href="#legacy-error-middleware" class="toc__link">Legacy error middleware</a>
                    </li>
                
            </ul>
        </div>
    

                
            </div>
            <div class="col-md-7 col-sm-12 content" role="main" data-spy="scroll" data-target=".toc">
                
                    <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        
            <li class="breadcrumb-item"><a href="https://docs.laminas.dev/">Overview</a></li>
            <li class="breadcrumb-item"><a href="https://docs.laminas.dev/components/">Components</a></li>

            
                <li class="breadcrumb-item"><a href="../..">laminas-stratigility</a></li>

                
                    
                        
                        
                    
                

                <li class="breadcrumb-item active" aria-current="page">Error Handlers</li>
            
        
    </ol>
</nav>



    <div class="alert alert-danger" role="alert">
        <h4>Caution</h4>
        <p>
            The documentation you are viewing is for an older version of this component.<br>
            <a href="../..">Switch to the latest (v3) version.</a>
        </p>
    </div>




    
    

    <h1 id="error-handlers">Error Handlers</h1>
<p>In your application, you may need to handle error conditions:</p>
<ul>
<li>Errors raised by PHP itself (e.g., inability to open a file or database
  connection).</li>
<li>Exceptions/throwables raised by PHP and/or code you write or consume.</li>
<li>Inability of any middleware to handle a request.</li>
</ul>
<p>You can typically handle these conditions via middleware itself.</p>
<h2 id="handling-404-conditions">Handling 404 conditions</h2>
<ul>
<li>Since 1.3.0</li>
</ul>
<p>If no middleware is able to handle the incoming request, this is typically
representative of an HTTP 404 status. Stratigility provides a barebones
middleware that you may register in an innermost layer that will return a 404
condition, <code>Laminas\Stratigility\Middleware\NotFoundHandler</code>. The class requires a
response prototype instance that it will use to provide the 404 status and a
message indicating the request method and URI used:</p>
<pre class=codehilite><code class=language-php>// setup layers
$app-&gt;pipe(/* ... */);
$app-&gt;pipe(/* ... */);
$app-&gt;pipe(new NotFoundHandler(new Response());

// execute application</code></pre>
<p>Note that it is the last middleware piped into the application! Since it returns
a response, no deeper nested layers will execute once it has been invoked.</p>
<p>If you would like a templated response, you will need to write your own
middleware; such middleware might look like the following:</p>
<pre class=codehilite><code class=language-php>use Interop\Http\Middleware\DelegateInterface;
use Interop\Http\Middleware\ServerMiddlewareInterface;
use Psr\Http\Message\ResponseInterface;
use Psr\Http\Message\ServerRequestInterface;

class NotFoundMiddleware implements ServerMiddlewareInterface
{
    private $renderer;

    public function __construct(
        TemplateRendererInterface $renderer,
        ResponseInterface $response
    ) {
        $this-&gt;renderer = $renderer;
        $this-&gt;response = $response;
    }

    public function process(ServerRequestInterface $request, DelegateInterface $delegate)
    {
        $response = $this-&gt;response-&gt;withStatus(404);
        $response-&gt;getBody()-&gt;write(
            $this-&gt;renderer-&gt;render('error::404')
        );
        return $response;
    }
}</code></pre>
<h2 id="handling-php-errors-and-exceptions">Handling PHP errors and exceptions</h2>
<ul>
<li>Since 1.3.0</li>
</ul>
<blockquote>
<h3>Opting in to error middleware</h3>
<p>If you have upgraded from Mezzio 1.0.0, you will have been using the
<code>FinalHandler</code> implementation, and relying on the fact that, internally,
dispatching wraps all middleware in <code>try/catch</code> blocks.</p>
<p>Starting in 1.3.0, we provide a new way to handle errors via middleware.</p>
<p><strong>To opt-in to the new system, you must call <code>raiseThrowables()</code> on your
middleware pipeline:</strong></p>
<pre class="codehilite"><code class="language-php">
$pipeline = new MiddlewarePipe();
$pipeline-&gt;raiseThrowables();
</code></pre>
<p>(Starting in 2.0.0, this will no longer be necessary, but until then, this is
how you opt-in to the system described below.)</p>
</blockquote>
<p><code>Laminas\Stratigility\Middleware\ErrorHandler</code> is a middleware implementation to
register as the <em>outermost layer</em> of your application (or close to the outermost
layer). It does the following:</p>
<ul>
<li>Creates a PHP error handler that catches any errors in the <code>error_handling()</code>
  mask and throws them as <code>ErrorException</code> instances.</li>
<li>Wraps the invocation of the delegate in a try/catch block:</li>
<li>if no exception is caught, and the result is a response, it returns it.</li>
<li>if no exception is caught, it raises an exception, which will be caught.</li>
<li>any caught exception is transformed into an error response.</li>
</ul>
<p>To generate the error response, we provide the ability to inject a callable with
the following signature into the <code>ErrorHandler</code> during instantiation:</p>
<pre class=codehilite><code class=language-php>Psr\Http\Message\ResponseInterface;
Psr\Http\Message\ServerRequestInterface;

function (
    Throwable|Exception $e,
    ServerRequestInterface $request,
    ResponseInterface $response
) : ResponseInterface</code></pre>
<p>We provide a default implementation, <code>Laminas\Stratigility\Middleware\ErrorResponseGenerator</code>,
which generates an error response with a <code>5XX</code> series status code and a message
derived from the reason phrase, if any is present. You may pass a boolean flag
to its constructor indicating the application is in development mode; if so, the
response will have the stack trace included in the body.</p>
<p>In order to work, the <code>ErrorHandler</code> needs a prototype response instance, and,
optionally, an error response generator (if none is provided,
<code>ErrorResponseGenerator</code> is used, in production mode):</p>
<pre class=codehilite><code class=language-php>// setup error handling
$app-&gt;pipe(new ErrorHandler(new Response(), new ErrorResponseGenerator($isDevelopmentMode));

// setup layers
$app-&gt;pipe(/* ... */);
$app-&gt;pipe(/* ... */);</code></pre>
<p>As a full example, you can combine the two middleware into the same application
as separate layers:</p>
<pre class=codehilite><code class=language-php>// setup error handling
$app-&gt;pipe(new ErrorHandler(new Response(), new ErrorResponseGenerator($isDevelopmentMode));

// setup layers
$app-&gt;pipe(/* ... */);
$app-&gt;pipe(/* ... */);

// setup 404 handling
$app-&gt;pipe(new NotFoundHandler(new Response());

// execute application</code></pre>
<p>The <code>ErrorResponseGenerator</code> provides no templating facilities, and only
responds as <code>text/html</code>. If you want to provide a templated response, or a
different serialization and/or markup format, you will need to write your own
error response generator.</p>
<p>As an example:</p>
<pre class=codehilite><code class=language-php>use ErrorException;
use Psr\Http\Message\ServerRequestInterface;
use Psr\Http\Message\ResponseInterface;
use Throwable;
use Laminas\Stratigility\Exception\MissingResponseException;
use Laminas\Stratigility\Middleware\ErrorHandler;

class TemplatedErrorResponseGenerator
{
    private $isDevelopmentMode;
    private $renderer;

    public function __construct(
        TemplateRendererInterface $renderer,
        $isDevelopmentMode = false
    ) {
        $this-&gt;renderer = $renderer;
        $this-&gt;isDevelopmentMode = $isDevelopmentMode;
    }

    public function __invoke($e, ServerRequestInterface $request, ResponseInterface $response)
    {
        $response = $response-&gt;withStatus(500);
        $response-&gt;getBody()-&gt;write($this-&gt;renderer-&gt;render('error::error', [
            'exception'        =&gt; $e,
            'development_mode' =&gt; $this-&gt;isDevelopmentMode,
        ]));
        return $response;
    }
}</code></pre>
<p>You would then pass this to the <code>ErrorHandler</code>:</p>
<pre class=codehilite><code class=language-php>$app-&gt;pipe(new ErrorHandler(
    new Response(),
    new TemplatedErrorResponseGenerator($renderer, $isDevelopmentMode)
));</code></pre>
<h3>ErrorHandler Listeners</h3>
<p><code>Laminas\Stratigility\Middleware\ErrorHandler</code> provides the ability to attach
<em>listeners</em>; these are triggered when an error or exception is caught, and
provided with the exception/throwable raised, the original request, and the
final response. These instances are considered immutable, so listeners are for
purposes of logging/monitoring only.</p>
<p>Listeners must implement the following signature:</p>
<pre class=codehilite><code class=language-php>Psr\Http\Message\ResponseInterface;
Psr\Http\Message\ServerRequestInterface;

function (
    Throwable|Exception $e,
    ServerRequestInterface $request,
    ResponseInterface $response
) : void</code></pre>
<p>Attach listeners using <code>ErrorHandler::attachListener()</code>:</p>
<pre class=codehilite><code class=language-php>$errorHandler-&gt;attachListener(function ($throwable, $request, $response) use ($logger) {
    $message = sprintf(
        '[%s] %s %s: %s',
        date('Y-m-d H:i:s'),
        $request-&gt;getMethod(),
        (string) $request-&gt;getUri(),
        $throwable-&gt;getMessage()
    );
    $logger-&gt;error($message);
});</code></pre>
<h2 id="legacy-error-middleware">Legacy error middleware</h2>
<ul>
<li>Deprecated starting in 1.3.0, to be removed in 2.0.0. Please see the
  <a href="../../v2/migration/#error-handling">v2 migration guide</a> for more details, as well
  as the preceding section.</li>
</ul>
<p>To handle errors, you can write middleware that accepts <strong>exactly</strong> four arguments:</p>
<pre class=codehilite><code class=language-php>function ($error, $request, $response, $next) { }</code></pre>
<p>Alternately, you can implement <code>Laminas\Stratigility\ErrorMiddlewareInterface</code>.</p>
<p>When using <code>MiddlewarePipe</code>, as the queue is executed, if <code>$next()</code> is called with an argument, or
if an exception is thrown, middleware will iterate through the queue until the first such error
handler is found. That error handler can either complete the request, or itself call <code>$next()</code>.
<strong>Error handlers that call <code>$next()</code> SHOULD call it with the error it received itself, or with
another error.</strong></p>
<p>Error handlers are usually attached at the end of middleware, to prevent attempts at executing
non-error-handling middleware, and to ensure they can intercept errors from any other handlers.</p>




    <nav>
    <ul class="page-nav hidden-print">

        
        <li class="page-nav__item">
            
                <a rel="prev" class="page-nav__link page-nav__link--prev" href="../middleware/">
                    <i class="fa fa-chevron-left"></i> Previous
                </a>
            
        </li>

        
        <li class="page-nav__item">
            
                <a rel="next" class="page-nav__link page-nav__link--next" href="../creating-middleware/">
                    Next <i class="fa fa-chevron-right"></i>
                </a>
            
        </li>
    </ul>
</nav>




    <div class="help-wanted">
        <p>
            Found a mistake or want to contribute to the documentation?
            <a href="https://github.com/laminas/laminas-stratigility/edit/master/docs/book/v1/error-handlers.md" target="_blank" class="help-wanted__link">
                Edit this page on GitHub!
            </a>
        </p>
    </div>

                
            </div>
            <div class="col-md-3 col-sm-12 sidebar">
                
                    <div class="component-selector">
    
    <h5 class="component-selector__subtitle">Find documentation…</h5>
    <select class="form-control component-selector__control">
        <option value="/">Overview</option>
        <optgroup label="Components"></optgroup>
    </select>
</div>
                    
    <div class="subnavigation hidden-print">
        <h4 class="subnavigation__title">
            <a href="../..">laminas-stratigility</a>
        </h4>

        <h5 class="subnavigation__subtitle">Table of Contents</h5>

        <ul class="subnavigation__list">
            

                
                

                    
                    
                
            

                
                

                    
                    
                
            

                
                
                    
                        
    <li class="subnavigation__list-item ">
        <a href="../install/" class="subnavigation__link">Installation and Requirements</a>
    </li>

                    
                        
    <li class="subnavigation__list-item ">
        <a href="../usage/" class="subnavigation__link">Usage</a>
    </li>

                    
                        
    <li class="subnavigation__list-item ">
        <a href="../middleware/" class="subnavigation__link">Middleware</a>
    </li>

                    
                        
    <li class="subnavigation__list-item subnavigation__list-item--active">
        <a href="./" class="subnavigation__link">Error Handlers</a>
    </li>

                    
                        
    <li class="subnavigation__list-item ">
        <a href="../creating-middleware/" class="subnavigation__link">Creating Middleware</a>
    </li>

                    
                        
    <li class="subnavigation__list-item ">
        <a href="../executing-middleware/" class="subnavigation__link">Executing and composing middleware</a>
    </li>

                    
                        
    <li class="subnavigation__list-item ">
        <a href="../api/" class="subnavigation__link">API Reference</a>
    </li>

                    
                
            
        </ul>
    </div>

                
            </div>
        </div>
    </div>

    
    <footer class="footer">
    <div class="container">

        
        <div class="row">
            <div class="col-md-12 text-center">
                <a class="footer__button" href="#page-top"><i class="fa fa-chevron-up" aria-hidden="true"></i></a>
            </div>
        </div>

        <div class="row">
            <div class="col-md-7 offset-md-2">
                <h5>Laminas</h5>
                <ul>
                    <li>Laminas Project <a href="https://getlaminas.org/">The new foundation for the community-supported, open source continuation of Zend Framework</a></li>
                    <li>Laminas Components and MVC <a href="https://docs.laminas.dev/">Components and MVC for enterprise applications</a></li>
                    <li>Mezzio <a href="https://docs.mezzio.dev/">PSR-15 middleware in minutes</a></li>
                    <li>Laminas API Tools <a href="https://api-tools.getlaminas.org/">Build RESTful APIs in minutes</a></li>
                </ul>
            </div>
        </div>

        <div class="row">

            
            <div class="col-md-4 offset-md-2">
                <h4 class="footer__headline">Support</h4>
                <ul class="support__list">
                    <li class="support__list-item">
                        <a href="https://discourse.laminas.dev" class="support__link" title="Forum"><i class="fa fa-comments"></i></a>
                    </li>
                    <li class="support__list-item">
                        <a href="https://laminas.dev/chat" class="support__link" title="Chat"><i class="fa fa-slack"></i></a>
                    </li>
                    <li class="support__list-item">
                        <a href="https://github.com/laminas" class="support__link" title="Github"><i class="fa fa-github"></i></a>
                    </li>
                    <li class="support__list-item">
                        <a href="https://twitter.com/getlaminas" class="support__link" title="Twitter"><i class="fa fa-twitter"></i></a>
                    </li>
                    <li class="support__list-item">
                        <a href="https://getlaminas.org/blog/feed-rss.xml" class="support__link" title="Blog feed"><i class="fa fa-rss"></i></a>
                    </li>
                    <li class="support__list-item">
                        <a href="https://getlaminas.org/security/feed" class="support__link" title="Security feed"><i class="fa fa-rss-square"></i></a>
                    </li>
                </ul>
            </div>

            
            <div class="col-md-3">
                <h4 class="footer__headline">License</h4>
                <p>
                    Code licensed under <a
                        href="https://github.com/laminas/laminas-stratigility/blob/master/LICENSE.md">BSD 3-Clause</a>.
                </p>
            </div>

            
            <div class="col-md-3">
                <h4 class="footer__headline">Copyright</h4>
                <p>
                    <!--Built with love by the Laminas team with the help of our
                    <a href="https://github.com/laminas/laminas-stratigility/graphs/contributors">contributors</a>.<br>-->
                    &copy; 2019-2020 by <a href="https://getlaminas.org/">The Laminas Project</a>.
                </p>
            </div>
        </div>
    </div>
</footer>

    <script>
        let base_url = '../..',
            project  = "components",
            siteName = 'laminas-stratigility';
    </script>
    <script src="https://docs.laminas.dev/js/scripts.js"></script>
        <script src="../../search/main.js"></script>

    
    <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Search</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                    <span class="sr-only">Close</span>
                </button>
            </div>
            <div class="modal-body">
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search in laminas-stratigility" id="mkdocs-search-query">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
        </div>
    </div>
</div>
</body>


</html>
